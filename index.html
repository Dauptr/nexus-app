<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NEXUS OS V17.0 | Universal Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    :root {
      --primary: #6366f1; --primary-light: #818cf8;
      --accent: #ec4899; --accent-light: #f472b6;
      --bg-dark: #050507; --bg-card: rgba(20, 20, 25, 0.6);
      --glass: rgba(255,255,255,0.03); --glass-border: rgba(255,255,255,0.08);
      --text-main: #f8fafc; --text-muted: #94a3b8;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --cyan: #22d3ee; --magenta: #f43f5e;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); }

    /* Layout */
    #app-shell { display: flex; height: 100%; width: 100%; position: relative; }
    
    /* Sidebar */
    .sidebar { 
      width: 260px; height: 100%; background: rgba(10, 10, 15, 0.8); border-right: 1px solid var(--glass-border); 
      display: flex; flex-direction: column; padding: 1.5rem; z-index: 100; transition: transform 0.3s ease, width 0.3s ease;
      position: fixed; left: 0; top: 0; backdrop-filter: blur(20px);
    }
    .sidebar.collapsed { transform: translateX(-100%); }
    
    .brand { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; font-weight: 700; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem; }
    .brand::before { content: ''; width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }
    
    .nav-section { margin-bottom: 1.5rem; }
    .nav-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 0.75rem; padding-left: 0.5rem; }
    .nav-item { 
      display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 8px; color: var(--text-muted); 
      cursor: pointer; transition: all 0.2s; margin-bottom: 4px; font-size: 0.9rem; font-weight: 500;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
    .nav-item.active { background: rgba(99, 102, 241, 0.15); color: var(--primary-light); }
    .nav-item.active::before { content: ''; position: absolute; left: 0; width: 3px; height: 24px; background: var(--primary-light); border-radius: 0 4px 4px 0; }

    /* Main Content */
    .main-content { flex: 1; margin-left: 260px; height: 100%; display: flex; flex-direction: column; transition: margin-left 0.3s ease; position: relative; }
    .main-content.expanded { margin-left: 0; }
    
    .topbar { 
      height: 60px; border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; 
      justify-content: space-between; padding: 0 2rem; background: rgba(5,5,7,0.8); backdrop-filter: blur(10px); z-index: 50;
    }
    .page-title { font-family: 'JetBrains Mono', monospace; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; }
    .topbar-actions { display: flex; gap: 1rem; align-items: center; }

    .page-container { flex: 1; padding: 2rem; overflow-y: auto; scroll-behavior: smooth; background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.05), transparent 40%); }

    /* Components */
    .card { background: var(--bg-card); border: 1px solid var(--glass-border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; backdrop-filter: blur(10px); transition: transform 0.2s; }
    .card:hover { border-color: rgba(99, 102, 241, 0.2); }
    
    .btn { 
      padding: 10px 20px; border-radius: 8px; border: 1px solid transparent; font-family: inherit; font-size: 0.9rem; 
      font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
    }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
    .btn-primary:hover { background: var(--primary-light); transform: translateY(-1px); }
    .btn-ghost { background: transparent; border-color: var(--glass-border); color: var(--text-muted); }
    .btn-ghost:hover { background: var(--glass); color: var(--text-main); }
    
    .input-group { margin-bottom: 1rem; }
    .input-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 500; }
    .input-field { 
      width: 100%; padding: 12px 16px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); 
      border-radius: 8px; color: var(--text-main); font-family: inherit; font-size: 0.9rem; outline: none; transition: border-color 0.2s;
    }
    .input-field:focus { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }

    /* Utilities */
    .flex { display: flex; } .flex-col { flex-direction: column; } .gap-1 { gap: 0.5rem; } .gap-2 { gap: 1rem; }
    .items-center { align-items: center; } .justify-between { justify-content: space-between; }
    .text-xs { font-size: 0.75rem; } .text-muted { color: var(--text-muted); } .font-mono { font-family: 'JetBrains Mono', monospace; }
    .w-full { width: 100%; } .h-full { height: 100%; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    
    /* Specialized Views */
    .chat-area { display: flex; flex-direction: column; height: calc(100vh - 160px); }
    .chat-messages { flex: 1; overflow-y: auto; padding-right: 0.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
    .msg-bubble { padding: 10px 14px; border-radius: 12px; max-width: 80%; font-size: 0.9rem; line-height: 1.5; white-space: pre-wrap; }
    .msg-user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-ai { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); align-self: flex-start; border-bottom-left-radius: 2px; }
    .msg-sys { background: rgba(255,255,255,0.02); color: var(--text-muted); align-self: center; font-size: 0.8rem; border: 1px dashed var(--glass-border); }

    .art-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
    .art-item { aspect-ratio: 1; border-radius: 12px; overflow: hidden; position: relative; background: #000; border: 1px solid var(--glass-border); cursor: pointer; transition: transform 0.2s; }
    .art-item:hover { transform: scale(1.02); z-index: 10; }
    .art-item img { width: 100%; height: 100%; object-fit: cover; }
    
    .video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; height: 100%; }
    .video-box { background: #000; border-radius: 12px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; border: 1px solid var(--glass-border); }
    .video-box video { width: 100%; height: 100%; object-fit: cover; }
    .video-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 1rem; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }

    .game-preview { width: 100%; height: 500px; background: #111; border-radius: 8px; border: 1px solid var(--glass-border); }
    
    /* Loading */
    .loader { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); width: 280px; }
      .sidebar.open { transform: translateX(0); box-shadow: 20px 0 50px rgba(0,0,0,0.5); }
      .main-content { margin-left: 0; }
      .grid-2 { grid-template-columns: 1fr; }
      .topbar { padding: 0 1rem; }
      .page-container { padding: 1rem; }
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
  </style>
</head>
<body>

<div id="app-shell">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidenav">
    <div class="brand">NEXUS</div>
    
    <div class="nav-section">
      <div class="nav-title">Main</div>
      <div class="nav-item active" data-nav="dashboard">üè† Dashboard</div>
      <div class="nav-item" data-nav="chat">üí¨ Chat Network</div>
      <div class="nav-item" data-nav="conference">üìπ Conference</div>
    </div>

    <div class="nav-section">
      <div class="nav-title">Create</div>
      <div class="nav-item" data-nav="art">üé® Art Studio</div>
      <div class="nav-item" data-nav="game-builder">üéÆ Game Builder</div>
      <div class="nav-item" data-nav="code">üíª Code Lab</div>
    </div>

    <div class="nav-section">
      <div class="nav-title">Tools</div>
      <div class="nav-item" data-nav="radio">üìª Radio</div>
      <div class="nav-item" data-nav="files">üìÅ Files</div>
    </div>

    <div style="margin-top:auto; padding-top:1rem; border-top: 1px solid var(--glass-border);">
      <div class="flex items-center gap-2">
        <div style="width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg, var(--primary), var(--accent)); display:flex; align-items:center; justify-content:center; font-weight:600;">U</div>
        <div>
          <div style="font-size:0.9rem; font-weight:600">User</div>
          <div style="font-size:0.7rem; color:var(--text-muted)">Universal Plan</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main-content" id="main-area">
    <header class="topbar">
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost" id="toggle-nav" style="padding: 8px;">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <div class="page-title" id="page-title">DASHBOARD</div>
      </div>
      <div class="topbar-actions">
        <div class="text-xs text-muted font-mono" id="clock">00:00:00</div>
      </div>
    </header>

    <div class="page-container" id="app-root">
      <!-- Dynamic Content Injects Here -->
    </div>
  </main>
</div>

<script>
  // ================== STATE MANAGEMENT ==================
  const State = {
    nav: 'dashboard',
    isLoading: false,
    chat: { messages: [], input: '', mode: 'ai' }, // mode: 'ai' or 'network'
    art: { history: [], prompt: '', mode: 'create', file: null }, // mode: 'create' or 'analyze'
    game: { code: '', prompt: '' },
    radio: { stations: [], playing: null },
    video: { stream: null }
  };

  // ================== CORE UTILITIES ==================
  const $ = (id) => document.getElementById(id);
  const $all = (sel) => document.querySelectorAll(sel);
  
  const Notify = (msg) => alert(msg); // Simple alert for now, could be toast

  const Clock = () => {
    const now = new Date();
    $('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false });
  };

  // ================== NAVIGATION ENGINE ==================
  const Router = {
    init: () => {
      $all('.nav-item').forEach(el => {
        el.addEventListener('click', () => {
          const target = el.dataset.nav;
          State.nav = target;
          Router.updateUI();
          Router.loadPage();
          // Close sidebar on mobile after click
          if (window.innerWidth < 768) $('sidenav').classList.remove('open');
        });
      });
      $('toggle-nav').addEventListener('click', () => {
        $('sidenav').classList.toggle('open');
      });
    },
    updateUI: () => {
      $all('.nav-item').forEach(el => {
        el.classList.toggle('active', el.dataset.nav === State.nav);
      });
      $('page-title').textContent = State.nav.replace('-', ' ').toUpperCase();
    },
    loadPage: () => {
      const pages = {
        'dashboard': Dashboard,
        'chat': Chat,
        'conference': Conference,
        'art': ArtStudio,
        'game-builder': GameBuilder,
        'code': CodeLab,
        'radio': Radio,
        'files': Files
      };
      $('app-root').innerHTML = pages[State.nav] ? pages[State.nav].render() : '<div class="card">Page not found</div>';
      pages[State.nav]?.init?.();
    }
  };

  // ================== PAGE: DASHBOARD ==================
  const Dashboard = {
    render: () => `
      <div class="flex flex-col gap-2" style="margin-bottom:2rem">
        <h1 style="font-size:2.5rem; font-weight:800; background:linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">Welcome to NEXUS</h1>
        <p class="text-muted">Universal Operating System. Secure. Intelligent. Limitless.</p>
      </div>
      
      <div class="grid-2">
        <div class="card">
          <h3 class="font-mono" style="color:var(--primary-light); margin-bottom:1rem">System Status</h3>
          <div class="flex flex-col gap-1">
            <div class="flex justify-between text-xs"><span>AI Core</span><span style="color:var(--success)">ONLINE</span></div>
            <div class="flex justify-between text-xs"><span>Network</span><span style="color:var(--success)">CONNECTED</span></div>
            <div class="flex justify-between text-xs"><span>Storage</span><span style="color:var(--warning)">45% USED</span></div>
            <div class="flex justify-between text-xs"><span>Security</span><span style="color:var(--success)">ACTIVE</span></div>
          </div>
        </div>
        <div class="card">
          <h3 class="font-mono" style="color:var(--primary-light); margin-bottom:1rem">Quick Actions</h3>
          <div class="flex gap-1" style="flex-wrap:wrap">
            <button class="btn btn-ghost" onclick="Router.navigate('art')">Generate Image</button>
            <button class="btn btn-ghost" onclick="Router.navigate('chat')">Ask AI</button>
            <button class="btn btn-ghost" onclick="Router.navigate('game-builder')">Build Game</button>
          </div>
        </div>
      </div>
    `
  };

  // ================== PAGE: CHAT (Network & AI) ==================
  // Simulated Network using BroadcastChannel (works across tabs/devices on same network in some browsers, primarily same-origin)
  const chatChannel = new BroadcastChannel('nexus_os_universal_chat');
  
  const Chat = {
    render: () => `
      <div class="card" style="height:calc(100vh - 160px); display:flex; flex-direction:column; padding:0;">
        <div class="flex items-center gap-2" style="padding:1rem; border-bottom:1px solid var(--glass-border);">
            <button class="btn ${State.chat.mode === 'ai' ? 'btn-primary' : 'btn-ghost'}" id="chat-mode-ai">AI Assistant</button>
            <button class="btn ${State.chat.mode === 'network' ? 'btn-primary' : 'btn-ghost'}" id="chat-mode-net">Local Network</button>
            <div class="flex-1"></div>
            <span class="text-xs text-muted">${State.chat.mode === 'ai' ? 'Model: GPT-4o' : 'Local Broadcast'}</span>
        </div>
        <div class="chat-messages" id="chat-log" style="flex:1; padding:1rem; overflow-y:auto;">
          ${State.chat.messages.map(m => Chat.renderMsg(m)).join('')}
        </div>
        <div style="padding:1rem; border-top:1px solid var(--glass-border);">
          <div class="flex gap-1">
            <input type="text" id="chat-input" class="input-field" placeholder="Type message..." value="${State.chat.input}">
            <button class="btn btn-primary" id="chat-send">Send</button>
          </div>
        </div>
      </div>
    `,
    renderMsg: (m) => {
      if(m.type === 'sys') return `<div class="msg-bubble msg-sys">${m.text}</div>`;
      if(m.type === 'ai') return `<div class="msg-bubble msg-ai"><span style="color:var(--primary-light); font-weight:600; font-size:0.8rem;">NEXUS AI</span><br>${m.text}</div>`;
      return `<div class="msg-bubble msg-user">${m.text}</div>`;
    },
    init: () => {
      const input = $('chat-input');
      const send = $('chat-send');
      
      $('chat-mode-ai').onclick = () => { State.chat.mode = 'ai'; Router.loadPage(); };
      $('chat-mode-net').onclick = () => { State.chat.mode = 'network'; Router.loadPage(); };

      const submit = () => {
        const text = input.value.trim();
        if(!text) return;
        
        // User Message
        State.chat.messages.push({ type: 'user', text: text });
        
        if(State.chat.mode === 'network') {
          chatChannel.postMessage({ type: 'user', text: text });
        } else {
          // AI Mode
          State.chat.messages.push({ type: 'sys', text: 'Thinking...' });
          Chat.callAI(text);
        }
        
        input.value = '';
        $('chat-log').innerHTML = State.chat.messages.map(m => Chat.renderMsg(m)).join('');
        $('chat-log').scrollTop = $('chat-log').scrollHeight;
      };

      send.onclick = submit;
      input.onkeydown = (e) => e.key === 'Enter' && submit();
      
      // Listen for network messages
      chatChannel.onmessage = (e) => {
        if(e.data.type === 'user') {
          State.chat.messages.push({ type: 'sys', text: `Network: ${e.data.text}` });
          $('chat-log').innerHTML = State.chat.messages.map(m => Chat.renderMsg(m)).join('');
        }
      };
    },
    callAI: async (prompt) => {
      try {
        // Using the requested syntax style
        const resp = await puter.ai.chat(prompt, { model: 'gpt-4o' });
        State.chat.messages.pop(); // Remove 'Thinking...'
        const text = typeof resp === 'string' ? resp : resp.message?.content;
        State.chat.messages.push({ type: 'ai', text: text });
      } catch(e) {
        State.chat.messages.pop();
        State.chat.messages.push({ type: 'sys', text: 'Error connecting to AI.' });
      }
      $('chat-log').innerHTML = State.chat.messages.map(m => Chat.renderMsg(m)).join('');
    }
  };

  // ================== PAGE: ART STUDIO ==================
  const ArtStudio = {
    render: () => `
      <div class="grid-2" style="height:100%;">
        <div class="card flex flex-col gap-2">
          <h2 style="font-weight:600">Creative Studio</h2>
          <p class="text-xs text-muted">Powered by Puter AI (Grok & OpenAI)</p>
          
          <div class="flex gap-1">
            <button class="btn ${State.art.mode === 'create' ? 'btn-primary' : 'btn-ghost'}" id="mode-create">Create</button>
            <button class="btn ${State.art.mode === 'analyze' ? 'btn-primary' : 'btn-ghost'}" id="mode-analyze">Analyze</button>
          </div>

          <div class="input-group">
            <label class="input-label">Prompt</label>
            <textarea id="art-prompt" class="input-field" style="height:100px; resize:none;">${State.art.prompt}</textarea>
          </div>

          ${State.art.mode === 'analyze' ? `
            <div class="input-group">
              <label class="input-label">Upload Image for Analysis</label>
              <input type="file" id="art-file" class="input-field" accept="image/*">
            </div>
          ` : `
            <div class="input-group">
              <label class="input-label">Model</label>
              <select id="art-model" class="input-field">
                <option value="grok-2-image">Grok-2-Image (xAI)</option>
                <option value="dall-e-3">DALL-E 3</option>
                <option value="dall-e-2">DALL-E 2</option>
                <option value="stable-diffusion-xl">Stable Diffusion XL</option>
              </select>
            </div>
          `}

          <button class="btn btn-primary w-full" id="art-gen">${State.isLoading ? 'Processing...' : 'Generate'}</button>
        </div>
        
        <div class="card" style="overflow-y:auto;">
          <h3 style="margin-bottom:1rem">Gallery</h3>
          <div class="art-grid" id="art-gallery">
            ${State.art.history.map(img => `<div class="art-item"><img src="${img.url}" title="${img.prompt}"></div>`).join('')}
          </div>
        </div>
      </div>
    `,
    init: () => {
      $('mode-create').onclick = () => { State.art.mode = 'create'; Router.loadPage(); };
      $('mode-analyze').onclick = () => { State.art.mode = 'analyze'; Router.loadPage(); };
      
      const genBtn = $('art-gen');
      const promptEl = $('art-prompt');

      genBtn.onclick = async () => {
        const prompt = promptEl.value.trim();
        if(!prompt) return;
        
        State.isLoading = true;
        genBtn.innerText = 'Processing...';
        genBtn.disabled = true;

        try {
          if(State.art.mode === 'create') {
            const model = $('art-model').value;
            // Use specific txt2img syntax requested or fallback
            let img;
            if(model === 'grok-2-image') {
              img = await puter.ai.txt2img({ prompt, model: 'grok-2-image', provider: 'xai' });
            } else {
              img = await puter.ai.txt2img(prompt, { model });
            }
            
            // Puter returns an image element or URL
            const url = img instanceof HTMLImageElement ? img.src : img.url;
            State.art.history.unshift({ url, prompt });
            
          } else {
            // Analyze Mode
            const fileInput = $('art-file');
            if(fileInput.files.length > 0) {
               const file = fileInput.files[0];
               // For vision, usually we pass the prompt and the file/url
               // The requested syntax: puter.ai.chat("prompt", "url/image", {model})
               // We need to convert file to a usable format or pass the file object if supported
               // Assuming puter.js supports file blobs or we need a helper to upload or base64
               // Simplified: using prompt text for now as file handling in browser varies
               const result = await puter.ai.chat(prompt, file, { model: 'gpt-4o' });
               alert("AI Analysis: " + (result.message?.content || result));
            } else {
              alert("Please upload an image to analyze.");
            }
          }
        } catch(e) {
          console.error(e);
          Notify("Error: " + e.message);
        }

        State.isLoading = false;
        Router.loadPage(); // Refresh view
      };
    }
  };

  // ================== PAGE: GAME BUILDER ==================
  const GameBuilder = {
    render: () => `
      <div class="card flex flex-col gap-2">
        <div class="flex items-center justify-between">
          <h2>AI Game Builder</h2>
          <span class="text-xs text-muted">Generates HTML5 Games</span>
        </div>
        
        <div class="flex gap-1">
          <input type="text" id="game-prompt" class="input-field" placeholder="Describe your game (e.g., 'Space shooter with neon graphics')" value="${State.game.prompt}">
          <button class="btn btn-primary" id="game-gen">Build</button>
        </div>
      </div>

      <div class="card">
        <div class="flex justify-between items-center mb-2">
          <h3>Preview</h3>
          <button class="btn btn-ghost" id="game-run">‚ñ∂ Run</button>
        </div>
        <div class="game-preview">
          <iframe id="game-frame" style="width:100%; height:100%; border:none; background:#000;"></iframe>
        </div>
      </div>
    `,
    init: () => {
      $('game-gen').onclick = async () => {
        const prompt = $('game-prompt').value;
        if(!prompt) return;
        
        State.game.prompt = prompt;
        $('game-gen').innerText = 'Generating...';
        
        // Ask AI to write a game inside a single HTML file
        const sysPrompt = "You are a Game Developer AI. Write a complete, single-file HTML5 game using Canvas or plain JS/CSS based on the user description. Output ONLY the code. No explanations. Use strict mode.";
        
        try {
          const response = await puter.ai.chat([
            { role: 'system', content: sysPrompt },
            { role: 'user', content: prompt }
          ], { model: 'gpt-4o' });
          
          let code = response.message?.content || response;
          // Strip markdown code blocks if present
          code = code.replace(/```html|```/g, '').trim();
          State.game.code = code;
          
          // Auto-run
          const iframe = $('game-frame');
          iframe.srcdoc = code;
        } catch(e) {
          Notify("Error generating game code: " + e.message);
        }
        
        $('game-gen').innerText = 'Build';
      };

      $('game-run').onclick = () => {
        if(State.game.code) {
          $('game-frame').srcdoc = State.game.code;
        }
      };
    }
  };

  // ================== PAGE: VIDEO CONFERENCE ==================
  const Conference = {
    render: () => `
      <div class="card" style="height:calc(100vh - 160px); display:flex; flex-direction:column;">
        <div class="flex justify-between items-center mb-2">
          <h2>Conference Room</h2>
          <div class="flex gap-1">
            <button class="btn ${State.video.stream ? 'btn-primary' : 'btn-ghost'}" id="vid-start">Camera</button>
            <button class="btn btn-ghost" id="vid-share">Share Screen</button>
          </div>
        </div>
        <div class="video-grid" style="flex:1">
          <div class="video-box">
            <video id="local-vid" autoplay muted playsinline></video>
            <div class="video-overlay">
              <div style="font-weight:600">You</div>
              <div class="text-xs text-muted">Local Stream</div>
            </div>
          </div>
          <div class="video-box">
            <div class="flex flex-col items-center justify-center text-muted">
              <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
              <div style="margin-top:1rem">Waiting for participants...</div>
            </div>
          </div>
        </div>
      </div>
    `,
    init: () => {
      const vid = $('local-vid');
      
      $('vid-start').onclick = async () => {
        if(State.video.stream) {
          State.video.stream.getTracks().forEach(t => t.stop());
          State.video.stream = null;
          vid.srcObject = null;
          $('vid-start').classList.remove('btn-primary');
          $('vid-start').classList.add('btn-ghost');
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            State.video.stream = stream;
            vid.srcObject = stream;
            $('vid-start').classList.add('btn-primary');
            $('vid-start').classList.remove('btn-ghost');
          } catch(e) {
            Notify("Could not access camera.");
          }
        }
      };
    }
  };

  // ================== PAGE: RADIO ==================
  const Radio = {
    render: () => `
      <div class="card">
        <div class="flex justify-between items-center mb-2">
          <h2>World Radio</h2>
          <input type="text" id="radio-search" class="input-field" style="width:200px" placeholder="Search stations...">
        </div>
        <div class="flex gap-2" style="overflow-x:auto; padding-bottom:1rem;">
            ${State.radio.stations.map(s => `
              <div class="card" style="min-width:150px; cursor:pointer; text-align:center" onclick="Radio.play('${s.url}')">
                <div style="font-size:1.5rem; margin-bottom:0.5rem">üìª</div>
                <div style="font-weight:600; font-size:0.9rem">${s.name}</div>
                <div class="text-xs text-muted">${s.country}</div>
              </div>
            `).join('')}
        </div>
        ${State.radio.playing ? `<div class="text-xs text-muted">Now Playing: ${State.radio.playing}</div>` : ''}
      </div>
    `,
    init: async () => {
      if(State.radio.stations.length === 0) {
        // Load some default stations
        try {
          const res = await fetch('https://de1.api.radio-browser.info/json/stations/search?limit=10&tag=jazz');
          const data = await res.json();
          State.radio.stations = data.map(s => ({ name: s.name, url: s.url_resolved, country: s.country }));
        } catch(e) {
          console.error("Radio API failed");
        }
      }
      
      $('radio-search').onkeydown = async (e) => {
        if(e.key === 'Enter') {
           const q = e.target.value;
           const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?name=${q}&limit=10`);
           const data = await res.json();
           State.radio.stations = data.map(s => ({ name: s.name, url: s.url_resolved, country: s.country }));
           Router.loadPage();
        }
      };
    },
    play: (url) => {
      if(!window.audio) window.audio = new Audio();
      window.audio.src = url;
      window.audio.play();
      State.radio.playing = url;
      Router.loadPage();
    }
  };
  
  // ================== PAGE: CODE LAB ==================
  const CodeLab = {
    render: () => `
      <div class="card" style="height:calc(100vh - 160px); display:flex; flex-direction:column;">
        <div class="flex justify-between items-center mb-1">
          <h2>HTML5 Sandbox</h2>
          <button class="btn btn-primary btn-small" id="code-run">Run Code</button>
        </div>
        <div class="grid-2" style="flex:1; gap:0;">
          <textarea id="code-editor" class="input-field" style="height:100%; border-radius:0; font-family:monospace; resize:none;"><h1 style="color:#22d3ee">Hello NEXUS</h1>
<button onclick="alert('System Ready')">Initialize</button></textarea>
          <iframe id="code-frame" style="height:100%; background:#fff; border:none;"></iframe>
        </div>
      </div>
    `,
    init: () => {
      $('code-run').onclick = () => {
        $('code-frame').srcdoc = $('code-editor').value;
      };
    }
  };

  // ================== PAGE: FILES ==================
  const Files = {
    render: () => `
      <div class="card">
        <div class="flex justify-between items-center mb-2">
          <h2>My Files</h2>
          <button class="btn btn-ghost" onclick="Files.upload()">Upload</button>
        </div>
        <div id="file-list" class="flex flex-col gap-1"></div>
      </div>
    `,
    init: () => {
      Files.load();
    },
    load: async () => {
      try {
        // Check if puter filesystem is available
        const items = await puter.fs.readdir('/');
        const list = $('file-list');
        list.innerHTML = items.map(f => `
          <div class="flex items-center justify-between p-2 text-sm" style="border-bottom:1px solid var(--glass-border);">
            <span>${f.name}</span>
            <span class="text-xs text-muted">${f.is_dir ? 'Folder' : 'File'}</span>
          </div>
        `).join('');
      } catch(e) {
        $('file-list').innerHTML = '<div class="text-muted text-sm">Filesystem access requires Puter authentication.</div>';
      }
    },
    upload: async () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if(file) {
           try {
             await puter.fs.write(file.name, file);
             Files.load();
           } catch(err) {
             Notify("Upload failed");
           }
        }
      };
      input.click();
    }
  };

  // ================== INIT ==================
  window.addEventListener('load', () => {
    Router.init();
    Router.loadPage();
    setInterval(Clock, 1000); Clock();
  });

  // Global access for HTML onclick
  window.Router = Router;
  window.Radio = Radio;
  window.Files = Files;

</script>
</body>
</html>
