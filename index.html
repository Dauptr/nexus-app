<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS OS // COMMERCIAL INTERFACE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        :root { 
            --bg: #020204; --bg-secondary: #08080c; --fg: #e4e4e7; --muted: #52525b; 
            --accent: #00f0ff; --accent2: #ff00aa; --success: #00ff88; --warning: #ffaa00;
            --border: rgba(0, 240, 255, 0.1); 
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); overflow: hidden; height: 100vh; }
        .font-display { font-family: 'Orbitron', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(0,240,255,0.3); border-radius: 3px; }

        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); } 50% { box-shadow: 0 0 40px rgba(0, 240, 255, 0.4); } }
        @keyframes scan-line { 0% { top: -10%; } 100% { top: 110%; } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slide-in { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .glass { background: rgba(10, 10, 20, 0.6); backdrop-filter: blur(20px) saturate(180%); border: 1px solid var(--border); }
        .glass-heavy { background: rgba(5, 5, 10, 0.9); backdrop-filter: blur(25px); border: 1px solid rgba(0, 240, 255, 0.05); }
        
        .gradient-border { position: relative; background: rgba(0,0,0,0.4); border: 1px solid transparent; background-clip: padding-box; }
        .gradient-border::before { content: ''; position: absolute; inset: 0; z-index: -1; margin: -1px; border-radius: inherit; background: linear-gradient(135deg, var(--accent), var(--accent2)); }
        
        .btn-primary { 
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.2), rgba(0, 100, 120, 0.2)); 
            color: var(--accent); font-weight: 600; transition: all 0.3s; 
            border: 1px solid rgba(0, 240, 255, 0.3);
        }
        .btn-primary:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px rgba(0, 240, 255, 0.5); }
        
        .btn-premium { background: linear-gradient(135deg, #ff00aa, #aa00ff); color: white; border: none; }
        .btn-premium:hover { box-shadow: 0 0 25px rgba(255, 0, 170, 0.6); transform: translateY(-2px); }

        .chat-bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 13px; }
        .chat-bubble.user { background: linear-gradient(135deg, rgba(0, 240, 255, 0.2), rgba(0, 100, 120, 0.2)); border: 1px solid rgba(0, 240, 255, 0.2); }
        .chat-bubble.other { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .chat-bubble.system { background: rgba(255, 0, 170, 0.1); border: 1px solid rgba(255, 0, 170, 0.2); color: var(--accent2); font-size: 11px; text-align: center; }
        
        /* Cinematic Trailer Styles */
        #trailer-screen { z-index: 10000; background: black; position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .trailer-line { opacity: 0; transform: translateY(20px); transition: all 1s ease; }
        .trailer-line.visible { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body class="bg-black text-gray-100 overflow-hidden">

    <!-- CINEMATIC TRAILER SCREEN -->
    <div id="trailer-screen" class="hidden">
        <div id="trailer-content" class="text-center px-4 max-w-2xl relative z-10"></div>
        <div class="absolute bottom-10 flex flex-col items-center gap-4 z-20">
            <button id="btn-enter-os" onclick="enterOS()" class="hidden btn-premium px-8 py-3 rounded-lg font-display text-sm tracking-widest animate-pulse">
                ENTER NEXUS
            </button>
            <button onclick="skipTrailer()" class="text-gray-600 text-xs hover:text-white transition font-mono">SKIP</button>
        </div>
    </div>

    <!-- BOOT SCREEN -->
    <div id="bootScreen" class="fixed inset-0 z-[999] flex flex-col items-center justify-center bg-black transition-opacity duration-1000 overflow-hidden">
        <div class="relative z-10 w-full max-w-sm px-4">
            <div class="glass rounded-xl p-6 shadow-2xl shadow-cyan-500/10">
                <div class="text-[10px] tracking-[0.4em] text-pink-400 opacity-80 mb-6 uppercase font-bold text-center">System Bootstrap</div>
                <div class="h-16 overflow-hidden text-xs font-mono text-gray-500 mb-4 flex flex-col-reverse" id="bootLog"></div>
                <div class="h-1 bg-gray-900 rounded-full overflow-hidden mb-4 relative">
                    <div id="bootProgress" class="h-full bg-gradient-to-r from-cyan-500 to-pink-500 w-0 transition-all duration-100 shadow-lg"></div>
                </div>
                <div class="flex justify-between text-[10px] font-mono text-gray-500">
                    <span id="bootStage">INIT</span>
                    <span><span id="bootPercent">0</span>%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="mainApp" class="hidden h-screen flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-12 glass border-b border-white/5 flex items-center justify-between px-4 md:px-6 z-50 flex-shrink-0">
            <div class="flex items-center gap-3">
                <h1 onclick="navigate('Chat')" class="font-display text-base font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-pink-400 cursor-pointer">NEXUS</h1>
                <span id="connectionStatus" class="hidden md:flex items-center gap-1 text-[10px] font-mono px-2 py-0.5 rounded-full bg-red-500/10 text-red-300 border border-red-500/20">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-400 animate-pulse"></span> OFFLINE
                </span>
            </div>
            
            <div class="flex items-center gap-2">
                <span id="premiumBadge" class="hidden md:flex items-center gap-1 text-[10px] font-mono px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-300 border border-yellow-500/20">PRO</span>
                <button onclick="showDocs()" class="p-2 rounded hover:bg-white/5 text-cyan-400 text-xs font-bold">DOCS</button>
                <button onclick="showProfile()" class="p-2 rounded hover:bg-white/5 text-gray-500 hover:text-white">üë§</button>
                <button onclick="showSettings()" class="p-2 rounded hover:bg-white/5 text-gray-500 hover:text-white">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="flex-1 flex overflow-hidden relative">
            <!-- Sidebar -->
            <aside id="sidebar" class="hidden md:flex w-52 glass-heavy border-r border-white/5 flex-col z-40 flex-shrink-0">
                <div class="p-3 flex-1 overflow-y-auto">
                    <div id="sidebarNav" class="flex flex-col gap-1"></div>
                </div>
                <div class="p-3 border-t border-white/5 text-center">
                     <div class="text-[10px] font-mono text-gray-600">NEXUS OS v10.2</div>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="mainContent" class="flex-1 overflow-hidden relative z-10 bg-gradient-to-br from-black via-gray-900/10 to-black flex flex-col"></main>
        </div>

        <!-- Mobile Bottom Nav -->
        <nav id="mobileNav" class="md:hidden h-14 glass border-t border-white/5 flex items-center justify-around z-50 overflow-x-auto flex-shrink-0"></nav>
    </div>

    <!-- MODALS -->

    <!-- Profile Modal (Improved) -->
    <div id="profileModal" class="fixed inset-0 z-[999] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="w-full max-w-lg bg-[#050508] rounded-xl p-6 border border-white/10 shadow-2xl relative">
            <button onclick="toggleProfile()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xl">√ó</button>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-cyan-400 font-display">Identity Profile</h2>
                <span id="profileStatusBadge" class="text-[10px] px-2 py-1 rounded bg-gray-800 text-gray-400">FREE</span>
            </div>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="col-span-1 flex flex-col items-center">
                    <div id="profileAvatar" class="w-20 h-20 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-3xl mb-2">üë§</div>
                    <button onclick="changeAvatar()" class="text-[10px] text-gray-400 hover:text-white">Change</button>
                </div>
                <div class="col-span-2 space-y-3">
                    <input type="text" id="profileName" class="w-full bg-black/30 border border-white/10 rounded p-2 text-sm" placeholder="Username">
                    <input type="text" id="profileStatus" class="w-full bg-black/30 border border-white/10 rounded p-2 text-sm" placeholder="Status message...">
                </div>
            </div>

            <!-- Environment Settings (Premium) -->
            <div class="glass p-3 rounded mb-6">
                <h3 class="text-xs font-bold text-gray-400 mb-2">Environment Theme</h3>
                <div id="envSettings" class="grid grid-cols-4 gap-2">
                    <div onclick="setEnv('cyber')" class="cursor-pointer h-10 rounded bg-gradient-to-r from-cyan-500 to-blue-500 border-2 border-transparent hover:border-white"></div>
                    <div onclick="setEnv('sunset')" class="cursor-pointer h-10 rounded bg-gradient-to-r from-orange-500 to-red-500 border-2 border-transparent hover:border-white"></div>
                    <div onclick="setEnv('nature')" class="cursor-pointer h-10 rounded bg-gradient-to-r from-green-500 to-emerald-500 border-2 border-transparent hover:border-white"></div>
                    <div onclick="setEnv('ghost')" class="cursor-pointer h-10 rounded bg-gradient-to-r from-gray-600 to-gray-800 border-2 border-transparent hover:border-white"></div>
                </div>
            </div>

            <!-- Link Generator -->
            <div class="glass p-3 rounded mb-4">
                <h3 class="text-xs font-bold text-gray-400 mb-2">Share Profile Link</h3>
                <div class="flex gap-2">
                    <input type="text" id="profileLink" class="flex-1 bg-black/40 border border-white/5 rounded px-2 text-xs font-mono text-cyan-400" readonly>
                    <button onclick="copyProfileLink()" class="btn-primary px-3 rounded text-xs">COPY</button>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="saveProfile()" class="flex-1 btn-primary py-2 rounded text-sm">Save Changes</button>
                <button onclick="openSubscriptionModal()" class="flex-1 btn-premium py-2 rounded text-sm font-bold">UPGRADE</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminModal" class="fixed inset-0 z-[999] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="w-full max-w-4xl bg-[#050508] rounded-xl p-6 border border-red-500/20 shadow-2xl relative">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold text-red-400 font-display">Admin Control Panel</h2>
                <button onclick="toggleAdmin()" class="text-gray-500 hover:text-white text-xl">√ó</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-xs font-mono text-left">
                    <thead class="border-b border-white/10 text-gray-400">
                        <tr>
                            <th class="p-3">User ID</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Status</th>
                            <th class="p-3">Plan</th>
                            <th class="p-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminUserList" class="text-gray-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Subscription/Payment Modal -->
    <div id="subscriptionModal" class="fixed inset-0 z-[999] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="w-full max-w-md bg-[#050508] rounded-xl overflow-hidden border border-pink-500/20 shadow-2xl relative">
            <div class="bg-gradient-to-r from-pink-600 to-purple-600 p-6 text-center">
                <h2 class="text-xl font-display font-bold text-white">NEXUS PRO</h2>
                <p class="text-xs text-white/80 mt-1">Unlock the full neural network</p>
            </div>
            <div class="p-6">
                <ul class="space-y-2 mb-6 text-xs text-gray-300">
                    <li class="flex items-center gap-2"><span class="text-green-400">‚úì</span> Unlimited AI Chat</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">‚úì</span> Priority Network Speed</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">‚úì</span> Custom Environments & Themes</li>
                    <li class="flex items-center gap-2"><span class="text-green-400">‚úì</span> Verified Badge</li>
                </ul>
                
                <div class="text-center mb-4">
                    <span class="text-3xl font-bold text-white">$9.99</span>
                    <span class="text-gray-400 text-sm">/ month</span>
                </div>

                <!-- PayPal Button Logic -->
                <button onclick="simulatePayment()" class="w-full btn-premium py-3 rounded-lg text-sm font-bold mb-2">
                    PAY WITH PAYPAL
                </button>
                <p class="text-[10px] text-gray-600 text-center">Payment sim to dauptr@gmail.com</p>
                <button onclick="toggleSubscriptionModal()" class="w-full text-center text-xs text-gray-500 hover:text-white mt-4">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Docs & Settings Modals -->
    <div id="docsModal" class="fixed inset-0 z-[999] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl overflow-y-auto">
        <div class="w-full max-w-2xl bg-[#050508] rounded-xl p-6 border border-white/10 shadow-2xl relative my-8">
            <button onclick="toggleDocs()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xl">√ó</button>
            <h2 class="text-lg font-bold mb-4 text-cyan-400 font-display">Documentation</h2>
            <div class="glass p-3 rounded text-xs font-mono text-gray-300">
                <p class="mb-2">Welcome to NEXUS OS.</p>
                <p>Commands: /ai, /img, /join, /name, /theme.</p>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[999] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="w-full max-w-md bg-[#050508] rounded-xl p-6 border border-white/10 shadow-2xl relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xl">√ó</button>
            <h2 class="text-lg font-bold mb-4 text-cyan-400 font-display">System Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-1">API Key (Optional)</label>
                    <input type="password" id="groqKeyInput" class="w-full p-2 rounded text-white text-sm bg-black/30 border border-white/10" />
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-400">Admin Mode</span>
                    <button onclick="toggleAdmin()" class="text-xs text-red-400 border border-red-500/20 px-2 py-1 rounded hover:bg-red-500/10">OPEN PANEL</button>
                </div>
                <button onclick="saveSettings()" class="w-full btn-primary py-2 rounded text-sm">Save Settings</button>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const CONFIG = {
        broker: 'wss://broker.emqx.io:8084/mqtt',
        baseTopic: 'nexus/os/',
        rooms: ['lobby', 'trading', 'support'],
        paypalLink: 'https://www.paypal.com/paypalme/dauptr', // Replace with actual link
        adminPass: 'nexusadmin' // Simple client-side check
    };

    // --- STATE ---
    let STATE = {
        view: 'Chat',
        booted: false,
        user: {
            id: localStorage.getItem('nexus_id') || `N-${Math.random().toString(36).substr(2, 6).toUpperCase()}`,
            name: localStorage.getItem('nexus_user') || 'Guest',
            avatar: localStorage.getItem('nexus_avatar') || 'üë§',
            status: 'Active',
            isPremium: localStorage.getItem('nexus_pro') === 'true',
            env: localStorage.getItem('nexus_env') || 'cyber'
        },
        chat: {
            client: null,
            connected: false,
            room: 'lobby',
            history: [],
            input: ''
        },
        db: {
            users: JSON.parse(localStorage.getItem('nexus_db_users')) || []
        }
    };

    // --- UTILS ---
    const $ = id => document.getElementById(id);
    const create = (tag, cls, html) => { const el = document.createElement(tag); if(cls) el.className = cls; if(html) el.innerHTML = html; return el; };
    const esc = str => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // --- TRAILER LOGIC ---
    window.onload = () => {
        if(localStorage.getItem('nexus_booted')) {
            $('trailer-screen').classList.add('hidden');
            initOS();
        } else {
            playTrailer();
        }
    };

    function playTrailer() {
        const screen = $('trailer-screen');
        const content = $('trailer-content');
        screen.classList.remove('hidden');
        screen.classList.add('flex');

        const scenes = [
            { t: "THE YEAR IS 2024", delay: 0, dur: 2000 },
            { t: "DATA IS THE NEW CURRENCY", delay: 2000, dur: 2000 },
            { t: "WELCOME TO THE NEXUS", delay: 4000, dur: 2000 },
            { t: "NEXUS OS", delay: 6500, dur: 0, style: 'text-4xl font-display text-cyan-400 glitch-text' }
        ];

        scenes.forEach(s => {
            setTimeout(() => {
                const div = create('div', `trailer-line text-xl text-white mb-4 ${s.style || ''}`, s.t);
                content.appendChild(div);
                setTimeout(() => div.classList.add('visible'), 100);
            }, s.delay);
        });

        setTimeout(() => {
            $('btn-enter-os').classList.remove('hidden');
        }, 7000);
    }

    function skipTrailer() {
        enterOS();
    }

    function enterOS() {
        $('trailer-screen').classList.add('hidden');
        localStorage.setItem('nexus_booted', 'true');
        initOS();
    }

    function initOS() {
        initBootSequence();
        initMQTT();
        initProfileLink();
        renderNavs();
        updatePremiumUI();
    }

    // --- BOOT ---
    async function initBootSequence() {
        const logs = $('bootLog');
        const steps = [
            { t: "BIOS Check...", w: 20 },
            { t: "Loading Environment...", w: 50 },
            { t: "System Ready", w: 100 }
        ];

        for(let step of steps) {
            const div = create('div', 'mb-1 text-cyan-400', `> ${step.t}`);
            logs.prepend(div);
            $('bootProgress').style.width = step.w + '%';
            $('bootPercent').innerText = step.w;
            await new Promise(r => setTimeout(r, 300));
        }
        
        setTimeout(() => {
            $('bootScreen').classList.add('hidden');
            $('mainApp').classList.remove('hidden');
            STATE.booted = true;
            navigate('Chat');
        }, 500);
    }

    // --- NAVIGATION ---
    const SECTIONS = [
        { id: 'Chat', icon: 'üí¨', label: 'Chat' },
        { id: 'Environment', icon: 'üå≥', label: 'My Space' },
        { id: 'Dashboard', icon: 'üìä', label: 'Stats' },
        { id: 'Admin', icon: 'üõ°Ô∏è', label: 'Admin' },
    ];

    function navigate(id) { STATE.view = id; render(); }
    
    function render() {
        renderNavs();
        const content = $('mainContent');
        content.className = "flex-1 overflow-hidden relative z-10 flex flex-col";
        
        switch(STATE.view) {
            case 'Chat': renderChat(content); break;
            case 'Environment': renderEnvironment(content); break;
            case 'Dashboard': renderDashboard(content); break;
            case 'Admin': renderAdmin(content); break;
            default: renderChat(content);
        }
    }

    function renderNavs() {
        $('sidebarNav').innerHTML = SECTIONS.map(s => `
            <button onclick="navigate('${s.id}')" class="w-full text-left px-3 py-2 rounded text-sm font-mono transition flex items-center gap-3 ${STATE.view === s.id ? 'text-cyan-300 bg-white/5' : 'text-gray-500 hover:bg-white/5'}">
                <span class="w-5 text-center">${s.icon}</span> 
                <span>${s.label}</span>
            </button>
        `).join('');

        $('mobileNav').innerHTML = SECTIONS.map(s => `
            <button onclick="navigate('${s.id}')" class="flex flex-col items-center text-[10px] px-3 py-2 whitespace-nowrap ${STATE.view === s.id ? 'text-cyan-400' : 'text-gray-500'}">
                <span class="text-lg mb-1">${s.icon}</span>
                <span>${s.label}</span>
            </button>
        `).join('');
    }

    // --- CHAT SYSTEM ---
    function renderChat(c) {
        c.innerHTML = `
            <div class="h-10 border-b border-white/5 flex items-center px-4 gap-2 flex-shrink-0 bg-black/20">
                ${CONFIG.rooms.map(r => `
                    <button onclick="joinRoom('${r}')" class="room-chip px-3 py-1 text-xs rounded-full border border-white/10 ${STATE.chat.room === r ? 'active' : 'text-gray-400'}">${r}</button>
                `).join('')}
            </div>
            <div id="chatLog" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
            <div class="p-3 border-t border-white/5 flex gap-2 bg-black/50 flex-shrink-0">
                <input type="text" id="chatInput" class="flex-1 bg-black/30 border border-white/10 rounded px-3 py-2 text-sm" placeholder="Message or /command..." />
                <button onclick="handleChatInput()" class="btn-primary px-4 py-2 rounded text-sm">SEND</button>
            </div>
        `;
        
        const log = $('chatLog');
        log.innerHTML = '';
        STATE.chat.history.forEach(msg => appendMessage(msg, false));
        
        const input = $('chatInput');
        input.value = STATE.chat.input;
        input.onkeydown = (e) => {
            STATE.chat.input = input.value;
            if(e.key === 'Enter') handleChatInput();
        };
    }

    function appendMessage(msg, animate = true) {
        const log = $('chatLog'); if (!log) return;
        const div = document.createElement('div');
        if(animate) div.style.animation = "fade-in 0.3s ease";
        
        let html = '';
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        if(msg.type === 'system') {
            html = `<div class="text-center"><span class="chat-bubble system">${esc(msg.text)}</span></div>`;
        } else {
            const isMe = msg.user === STATE.user.name;
            const badge = msg.premium ? '<span class="text-yellow-400 text-[8px] ml-1">PRO</span>' : '';
            html = `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div>
                        <div class="text-[10px] text-pink-400 mb-1 ml-1">${esc(msg.user)}${badge}</div>
                        <div class="chat-bubble ${isMe ? 'user' : 'other'}">${esc(msg.text)}</div>
                        <div class="text-[9px] text-gray-600 mt-1 ${isMe ? 'text-right mr-1' : 'ml-1'}">${time}</div>
                    </div>
                </div>
            `;
        }
        div.innerHTML = html;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    function addSystemMessage(text) {
        STATE.chat.history.push({ type: 'system', text, ts: Date.now() });
        appendMessage({ type: 'system', text });
    }

    function handleChatInput() {
        const input = $('chatInput');
        const text = input.value.trim(); if(!text) return;
        input.value = ''; STATE.chat.input = '';
        
        if(text.startsWith('/')) {
            handleCommand(text);
        } else {
            sendMessage(text);
        }
    }

    function sendMessage(text) {
        const msg = { type: 'user', user: STATE.user.name, text, ts: Date.now(), premium: STATE.user.isPremium };
        STATE.chat.history.push(msg);
        appendMessage(msg);
        
        if(STATE.chat.client && STATE.chat.connected) {
            const payload = JSON.stringify({ user: STATE.user.name, text, type: 'chat', premium: STATE.user.isPremium });
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = CONFIG.baseTopic + STATE.chat.room;
            STATE.chat.client.send(message);
        }
    }

    function handleCommand(str) {
        const parts = str.split(' ');
        const cmd = parts[0].toLowerCase();
        const args = parts.slice(1).join(' ');

        if(cmd === '/name' && args) {
            STATE.user.name = args;
            localStorage.setItem('nexus_user', args);
            addSystemMessage(`Identity changed to: ${args}`);
        } else if (cmd === '/theme' && args) {
            setEnv(args);
        } else if (cmd === '/ai' && args) {
            processAI(args);
        } else {
            addSystemMessage(`Unknown command. Try /name, /theme, /ai`);
        }
    }

    function joinRoom(room) {
        if(STATE.chat.room === room) return;
        if(STATE.chat.client && STATE.chat.connected) STATE.chat.client.unsubscribe(CONFIG.baseTopic + STATE.chat.room);
        STATE.chat.room = room;
        STATE.chat.history = [];
        render();
        if(STATE.chat.client && STATE.chat.connected) STATE.chat.client.subscribe(CONFIG.baseTopic + room);
        addSystemMessage(`Joined ${room}`);
    }

    // --- MQTT ---
    function initMQTT() {
        const clientId = "nexus-" + Math.random().toString(36).substr(2, 9);
        try {
            STATE.chat.client = new Paho.MQTT.Client('broker.emqx.io', 8084, clientId);
            
            STATE.chat.client.onMessageArrived = (message) => {
                try {
                    const payload = JSON.parse(message.payloadString);
                    if(payload.user !== STATE.user.name && payload.type === 'chat') {
                        const msg = { type: 'user', user: payload.user, text: payload.text, ts: Date.now(), premium: payload.premium };
                        STATE.chat.history.push(msg);
                        appendMessage(msg);
                    }
                } catch(e) {}
            };
            
            STATE.chat.client.connect({
                onSuccess: () => {
                    STATE.chat.connected = true;
                    updateConnectionStatus(true);
                    STATE.chat.client.subscribe(CONFIG.baseTopic + STATE.chat.room);
                },
                onFailure: () => setTimeout(initMQTT, 2000),
                useSSL: true
            });
        } catch(e) { console.error(e); }
    }

    function updateConnectionStatus(connected) {
        const el = $('connectionStatus');
        if(connected) {
            el.className = "hidden md:flex items-center gap-1 text-[10px] font-mono px-2 py-0.5 rounded-full bg-green-500/10 text-green-300 border border-green-500/20";
            el.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span> ONLINE';
        } else {
            el.className = "hidden md:flex items-center gap-1 text-[10px] font-mono px-2 py-0.5 rounded-full bg-red-500/10 text-red-300 border border-red-500/20";
            el.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-red-400 animate-pulse"></span> OFFLINE';
        }
    }

    // --- AI & PREMIUM FEATURES ---
    async function processAI(prompt) {
        if(!STATE.user.isPremium) {
            addSystemMessage("AI Chat requires PRO subscription.");
            openSubscriptionModal();
            return;
        }
        addSystemMessage(`AI Processing: "${prompt}"...`);
        // Mock AI Response
        setTimeout(() => {
            const msg = { type: 'user', user: 'NEXUS AI', text: "This is a simulated response for PRO user.", ts: Date.now() };
            STATE.chat.history.push(msg);
            appendMessage(msg);
        }, 1000);
    }

    function simulatePayment() {
        // Simulating PayPal webhook
        alert("Simulating successful payment...");
        STATE.user.isPremium = true;
        localStorage.setItem('nexus_pro', 'true');
        updatePremiumUI();
        toggleSubscriptionModal();
        addSystemMessage("PRO Activated. Welcome to the inner circle.");
        
        // Update mock DB
        saveUserToDB({ ...STATE.user, isPremium: true });
    }

    function updatePremiumUI() {
        if(STATE.user.isPremium) {
            $('premiumBadge').classList.remove('hidden');
            if($('profileStatusBadge')) {
                $('profileStatusBadge').innerText = "PRO";
                $('profileStatusBadge').className = "text-[10px] px-2 py-1 rounded bg-yellow-500/20 text-yellow-300 border border-yellow-500/20";
            }
        }
    }

    // --- INDIVIDUAL ENVIRONMENT ---
    function renderEnvironment(c) {
        const theme = {
            'cyber': 'from-cyan-900 to-black',
            'sunset': 'from-orange-900 to-black',
            'nature': 'from-green-900 to-black',
            'ghost': 'from-gray-800 to-black'
        }[STATE.user.env];

        c.className = `flex-1 overflow-hidden relative z-10 flex flex-col bg-gradient-to-b ${theme}`;
        c.innerHTML = `
            <div class="flex-1 flex flex-col items-center justify-center text-center p-8">
                <div class="text-6xl mb-4">${STATE.user.avatar}</div>
                <h2 class="text-2xl font-display text-white mb-2">${STATE.user.name}</h2>
                <p class="text-gray-400 text-sm mb-8">Personal Nexus Environment</p>
                
                <div class="glass p-4 rounded-xl w-full max-w-xs">
                    <div class="text-xs text-gray-400 mb-2">Quick Actions</div>
                    <button onclick="showProfile()" class="w-full btn-primary py-2 rounded text-xs mb-2">Customize Theme</button>
                    <button onclick="generateImage()" class="w-full btn-primary py-2 rounded text-xs">Generate Wallpaper</button>
                </div>
            </div>
        `;
    }

    function setEnv(theme) {
        STATE.user.env = theme;
        localStorage.setItem('nexus_env', theme);
        if(STATE.view === 'Environment') render();
        addSystemMessage(`Environment set to: ${theme}`);
    }

    // --- ADMIN PANEL ---
    function renderAdmin(c) {
        c.innerHTML = `
            <div class="h-full flex flex-col bg-black/40 p-6 overflow-y-auto">
                <h2 class="text-xl font-display text-red-400 mb-6">Admin Dashboard</h2>
                <div class="glass p-4 rounded-xl overflow-x-auto">
                    <table class="w-full text-xs font-mono">
                        <thead class="text-gray-400 border-b border-white/10">
                            <tr>
                                <td class="p-2">ID</td>
                                <td class="p-2">Name</td>
                                <td class="p-2">Status</td>
                                <td class="p-2">Action</td>
                            </tr>
                        </thead>
                        <tbody id="adminContent" class="text-gray-300"></tbody>
                    </table>
                </div>
            </div>
        `;
        const tbody = $('adminContent');
        tbody.innerHTML = STATE.db.users.map(u => `
            <tr class="border-b border-white/5">
                <td class="p-2">${u.id}</td>
                <td class="p-2">${u.name}</td>
                <td class="p-2 ${u.isPremium ? 'text-yellow-400' : 'text-gray-500'}">${u.isPremium ? 'PRO' : 'FREE'}</td>
                <td class="p-2">
                    <button onclick="toggleUserPremium('${u.id}')" class="px-2 py-1 rounded ${u.isPremium ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                        ${u.isPremium ? 'Revoke' : 'Activate'}
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function toggleUserPremium(id) {
        const user = STATE.db.users.find(u => u.id === id);
        if(user) {
            user.isPremium = !user.isPremium;
            localStorage.setItem('nexus_db_users', JSON.stringify(STATE.db.users));
            render();
        }
    }

    function saveUserToDB(userObj) {
        const index = STATE.db.users.findIndex(u => u.id === userObj.id);
        if(index >= 0) {
            STATE.db.users[index] = userObj;
        } else {
            STATE.db.users.push(userObj);
        }
        localStorage.setItem('nexus_db_users', JSON.stringify(STATE.db.users));
    }

    // --- PROFILE & LINK GEN ---
    function initProfileLink() {
        const data = btoa(JSON.stringify({ n: STATE.user.name, a: STATE.user.avatar, e: STATE.user.env }));
        const link = `${window.location.origin}${window.location.pathname}?u=${data}`;
        if($('profileLink')) $('profileLink').value = link;
        return link;
    }

    function copyProfileLink() {
        const link = initProfileLink();
        navigator.clipboard.writeText(link);
        alert("Profile link copied!");
    }

    function changeAvatar() {
        const avatars = ['üë§', 'ü§ñ', 'üëΩ', 'ü¶æ', 'üß¨', 'üé≠'];
        const current = avatars.indexOf(STATE.user.avatar);
        const next = (current + 1) % avatars.length;
        STATE.user.avatar = avatars[next];
        localStorage.setItem('nexus_avatar', STATE.user.avatar);
        $('profileAvatar').innerText = STATE.user.avatar;
    }

    function saveProfile() {
        STATE.user.name = $('profileName').value || STATE.user.name;
        STATE.user.status = $('profileStatus').value || STATE.user.status;
        localStorage.setItem('nexus_user', STATE.user.name);
        saveUserToDB(STATE.user);
        toggleProfile();
        addSystemMessage("Profile updated.");
    }

    // --- MODAL CONTROLS ---
    const toggleModal = (id, show) => {
        const el = $(id);
        if(show) { el.classList.remove('hidden'); el.classList.add('flex'); }
        else { el.classList.add('hidden'); el.classList.remove('flex'); }
    };

    // Expose functions to global scope for HTML events
    window.skipTrailer = skipTrailer;
    window.enterOS = enterOS;
    window.navigate = navigate;
    window.handleChatInput = handleChatInput;
    window.joinRoom = joinRoom;
    window.showDocs = () => toggleModal('docsModal', true);
    window.toggleDocs = () => toggleModal('docsModal', false);
    window.showSettings = () => toggleModal('settingsModal', true);
    window.toggleSettings = () => toggleModal('settingsModal', false);
    window.showProfile = () => { 
        initProfileLink(); 
        $('profileName').value = STATE.user.name; 
        $('profileAvatar').innerText = STATE.user.avatar;
        toggleModal('profileModal', true); 
    };
    window.toggleProfile = () => toggleModal('profileModal', false);
    window.toggleAdmin = () => toggleModal('adminModal', true);
    window.openSubscriptionModal = () => toggleModal('subscriptionModal', true);
    window.toggleSubscriptionModal = () => toggleModal('subscriptionModal', false);
    window.saveSettings = () => { alert("Settings saved"); toggleSettings(); };
    window.saveProfile = saveProfile;
    window.copyProfileLink = copyProfileLink;
    window.changeAvatar = changeAvatar;
    window.setEnv = setEnv;
    window.simulatePayment = simulatePayment;
    window.toggleUserPremium = toggleUserPremium;
    window.generateImage = () => alert("Image generation triggered for custom environment.");

</script>
</body>
</html>
