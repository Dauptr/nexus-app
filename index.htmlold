<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS OS // QUANTUM INTERFACE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        :root { 
            --bg: #020204; --bg-secondary: #08080c; --fg: #e4e4e7; --muted: #52525b; 
            --accent: #00f0ff; --accent2: #ff00aa; --success: #00ff88; --border: rgba(0, 240, 255, 0.1); 
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); overflow: hidden; height: 100vh; }
        .font-display { font-family: 'Orbitron', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(0,240,255,0.3); border-radius: 3px; }

        /* High-end Animations */
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); } 50% { box-shadow: 0 0 40px rgba(0, 240, 255, 0.4); } }
        @keyframes scan-line { 0% { top: -10%; } 100% { top: 110%; } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slide-right { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        
        .glass { background: rgba(10, 10, 20, 0.6); backdrop-filter: blur(20px) saturate(180%); border: 1px solid var(--border); }
        .glass-heavy { background: rgba(5, 5, 10, 0.9); backdrop-filter: blur(25px) saturate(200%); border: 1px solid rgba(0, 240, 255, 0.05); }
        
        .gradient-border { 
            position: relative; background: rgba(0,0,0,0.4); 
            border: 1px solid transparent; 
            background-clip: padding-box;
        }
        .gradient-border::before { 
            content: ''; position: absolute; inset: 0; z-index: -1; 
            margin: -1px; border-radius: inherit; 
            background: linear-gradient(135deg, var(--accent), var(--accent2)); 
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.2), rgba(0, 100, 120, 0.2)); 
            color: var(--accent); font-weight: 600; transition: all 0.3s; 
            border: 1px solid rgba(0, 240, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.1);
        }
        .btn-primary:hover { 
            background: var(--accent); color: #000; 
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.5); transform: translateY(-1px); 
        }
        
        /* Overlay Scan Effect */
        .scan-overlay::before {
            content: ''; position: absolute; left: 0; width: 100%; height: 10%;
            background: linear-gradient(transparent, rgba(0, 240, 255, 0.05), transparent);
            animation: scan-line 4s linear infinite; pointer-events: none; z-index: 100;
        }

        .trailer-text { animation: fade-in 1.2s ease-out forwards; opacity: 0; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 10px; width: 10px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -3px; box-shadow: 0 0 10px var(--accent); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
    </style>
</head>
<body class="bg-black text-gray-100 overflow-hidden">

    <!-- Boot Screen -->
    <div id="bootScreen" class="fixed inset-0 z-[999] flex flex-col items-center justify-center bg-black transition-opacity duration-1000">
        <canvas id="bootCanvas" class="absolute inset-0 z-0 opacity-30"></canvas>
        <div class="relative z-10 text-center w-full max-w-sm px-4">
            <div class="relative inline-block mb-8">
                <h1 class="font-display text-6xl tracking-widest text-cyan-400 relative z-10" style="text-shadow: 0 0 30px rgba(0,240,255,0.6);">NEXUS</h1>
                <div class="absolute inset-0 bg-cyan-500/10 blur-3xl rounded-full scale-150"></div>
            </div>
            
            <div class="glass rounded-xl p-6 shadow-2xl shadow-cyan-500/10">
                <div class="text-[10px] tracking-[0.4em] text-pink-400 opacity-80 mb-6 uppercase font-bold">System Initializing</div>
                
                <div class="h-16 overflow-hidden text-xs font-mono text-gray-400 mb-4 flex flex-col-reverse" id="bootLog"></div>
                
                <div class="h-0.5 bg-gray-900 rounded-full overflow-hidden mb-4">
                    <div id="bootProgress" class="h-full bg-gradient-to-r from-cyan-500 to-pink-500 w-0% transition-all duration-100 shadow-lg shadow-cyan-500/50"></div>
                </div>
                <div class="text-right text-xs font-mono text-gray-600"><span id="bootPercent">0</span>%</div>
            </div>
            <button id="skipBoot" class="hidden text-xs font-mono text-gray-600 hover:text-cyan-400 transition-colors mt-4">[ OVERRIDE ]</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden h-screen flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="h-12 glass border-b border-white/5 flex items-center justify-between px-4 md:px-6 z-50 flex-shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="font-display text-base font-bold tracking-wider text-cyan-400 cursor-pointer hover:opacity-80 transition" onclick="navigate('Dashboard')">NEXUS</h1>
                <span class="hidden md:flex items-center gap-1 text-[10px] font-mono px-2 py-0.5 rounded-full bg-green-500/10 text-green-300 border border-green-500/20">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span> SECURE
                </span>
            </div>
            <nav id="navBar" class="hidden lg:flex items-center gap-1 absolute left-1/2 -translate-x-1/2"></nav>
            
            <div class="flex items-center gap-2">
                <button onclick="showTrailer()" class="p-2 rounded hover:bg-white/5 text-gray-500 hover:text-white text-xs font-mono">INFO</button>
                <button onclick="toggleSettings()" class="p-2 rounded hover:bg-white/5 text-gray-500 hover:text-white">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="flex-1 flex overflow-hidden relative">
            <!-- Sidebar -->
            <aside id="sidebar" class="hidden md:flex w-52 glass-heavy border-r border-white/5 flex-col z-40 flex-shrink-0">
                <div class="p-3 flex-1 overflow-y-auto">
                    <div id="sidebarNav" class="flex flex-col gap-1"></div>
                </div>
                <div class="p-3 border-t border-white/5 text-center">
                     <div class="text-[10px] font-mono text-gray-600">NEXUS OS v9.5</div>
                </div>
            </aside>

            <!-- Main Content -->
            <main id="mainContent" class="flex-1 overflow-y-auto p-4 md:p-6 relative z-10"></main>
        </div>

        <!-- Mobile Bottom Nav -->
        <nav id="mobileNav" class="md:hidden h-14 glass border-t border-white/5 flex items-center justify-start px-2 z-50 overflow-x-auto flex-shrink-0"></nav>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="fixed inset-0 z-[999] hidden items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="w-full max-w-md bg-[#050508] rounded-xl p-6 border border-white/10 shadow-2xl relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white text-xl">√ó</button>
            <h2 class="text-lg font-bold mb-4 text-cyan-400">System Configuration</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-1">Groq API Key (Optional)</label>
                    <input type="password" id="groqKeyInput" placeholder="gsk_..." class="w-full p-2 rounded bg-black border border-white/10 text-white text-sm focus:outline-none focus:border-cyan-500" />
                    <p class="text-[10px] text-gray-600 mt-1">For ultra-fast inference.</p>
                </div>
                <div class="border-t border-white/5 pt-4">
                    <p class="text-xs text-gray-500">Engine Status:</p>
                    <p class="text-xs text-green-400 mt-1">‚úì Puter.js Unlimited</p>
                    <p class="text-xs text-green-400 mt-1">‚úì PeerJS P2P Connectivity</p>
                    <p class="text-xs text-cyan-400 mt-1">‚úì Hyperspace Active</p>
                </div>
            </div>
        </div>
    </div>

    <div id="trailerModal" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black flex-col p-8 text-center scan-overlay">
        <div id="trailerContent" class="max-w-2xl relative z-10"></div>
    </div>

<script>
    // --- STATE & CONFIG ---
    const STATE = {
        view: 'Hyperspace', // Start with the impressive feature
        booting: true, 
        progress: 0, 
        logs: [],
        user: { name: `User-${Math.floor(Math.random()*9999)}`, id: null },
        chatHistory: [],
        chatInput: '',
        p2p: { peer: null, conn: null, id: null, remoteId: '', messages: [] },
        img: { prompt: '', loading: false, progress: 0 },
        console: { history: [], input: '' },
        game: { running: false, score: 0, loop: null, x: 100, y: 150, vx: 0, vy: 0 },
        media: { tab: 'player', file: null },
        stats: { neural: 94, quantum: 12, ai: 99.7, nodes: 2847 }
    };

    const SECTIONS = [
        { id: 'Hyperspace', icon: 'üåå', label: 'Hyperspace' }, // The Impressive Feature
        { id: 'Dashboard', icon: 'üìä', label: 'Dashboard' },
        { id: 'ImageGen', icon: 'üé®', label: 'Image Gen' },
        { id: 'AIChat', icon: 'ü§ñ', label: 'AI Chat' },
        { id: 'P2PChat', icon: 'üë•', label: 'Network' },
        { id: 'Code', icon: 'üíª', label: 'Copilot' },
        { id: 'CLI', icon: '‚å®Ô∏è', label: 'Terminal' },
        { id: 'Media', icon: 'üé¨', label: 'Media' },
        { id: 'Game', icon: 'üéÆ', label: 'Game' },
        { id: 'System', icon: '‚öôÔ∏è', label: 'System' },
    ];

    // --- UTILS ---
    const $ = id => document.getElementById(id);
    const create = (tag, cls, html) => { const el = document.createElement(tag); if(cls) el.className = cls; if(html) el.innerHTML = html; return el; };
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    
    // --- AI ENGINE ---
    const AI = {
        async chat(prompt, onProgress) {
            if(onProgress) onProgress(10);
            const groqKey = $('groqKeyInput')?.value;
            
            if(groqKey) {
                try {
                    if(onProgress) onProgress(30);
                    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${groqKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: 'llama3-8b-8192', messages: [{ role: 'user', content: prompt }] })
                    });
                    if(onProgress) onProgress(90);
                    const data = await res.json();
                    if(data.choices && data.choices[0].message.content) {
                        if(onProgress) onProgress(100);
                        return data.choices[0].message.content;
                    }
                } catch (e) { console.warn("Groq fallback", e); }
            }

            try {
                if(onProgress) onProgress(50);
                const response = await puter.ai.chat(prompt);
                if(onProgress) onProgress(100);
                return typeof response === 'object' ? (response.message?.content || JSON.stringify(response)) : response;
            } catch (e) {
                if(onProgress) onProgress(100);
                return "System busy. Please retry.";
            }
        },
        
        async image(prompt, onProgress) {
            if(onProgress) onProgress(10);
            // Added seed to bypass cache and ensure fresh generation
            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=768&height=768&nologo=true&seed=${Date.now()}`;
            if(onProgress) onProgress(30);
            
            return new Promise((resolve) => {
                const img = new Image();
                img.src = imageUrl;
                img.onload = () => {
                    if(onProgress) onProgress(100);
                    resolve(imageUrl);
                };
                img.onerror = () => {
                    if(onProgress) onProgress(100);
                    resolve('https://placehold.co/512x512/000/0ff?text=Error');
                };
            });
        }
    };

    // --- BOOT SEQUENCE ---
    async function boot() {
        const logs = $('bootLog');
        const steps = [
            { t: "Quantum Core Initialized", w: 20 },
            { t: "Neural Mesh Connected", w: 45 },
            { t: "Hyperspace Link Active", w: 70 },
            { t: "System Ready", w: 100 }
        ];

        for(let step of steps) {
            const div = create('div', 'mb-1 text-cyan-400 opacity-0', step.t);
            logs.prepend(div);
            // Trigger reflow for animation
            void div.offsetHeight; 
            div.style.transition = 'opacity 0.2s'; div.style.opacity = 1;
            
            $('bootProgress').style.width = step.w + '%';
            $('bootPercent').innerText = step.w;
            await sleep(450);
        }
        
        $('skipBoot').classList.remove('hidden');
        $('skipBoot').onclick = finishBoot;
        await sleep(600);
        finishBoot();
    }

    function finishBoot() {
        $('bootScreen').style.opacity = '0';
        setTimeout(() => {
            $('bootScreen').classList.add('hidden');
            $('mainApp').classList.remove('hidden');
            initP2P(); 
            initStats();
            render(); 
        }, 500);
    }
    
    function initStats() {
        setInterval(() => {
            STATE.stats.neural = Math.min(100, STATE.stats.neural + (Math.random() - 0.5) * 2);
            STATE.stats.nodes += Math.floor((Math.random() - 0.5) * 10);
            if(STATE.view === 'Dashboard') updateDashboardStats();
        }, 1000);
    }
    
    function updateDashboardStats() {
        if($('statNeural')) $('statNeural').innerText = STATE.stats.neural.toFixed(1) + '%';
        if($('statNodes')) $('statNodes').innerText = Math.max(0, STATE.stats.nodes).toLocaleString();
    }

    // --- P2P ---
    function initP2P() {
        const peer = new Peer();
        peer.on('open', (id) => { STATE.user.id = id; if(STATE.view === 'P2PChat') render(); });
        peer.on('connection', (conn) => { STATE.p2p.conn = conn; setupConnection(conn); });
        STATE.p2p.peer = peer;
    }
    function connectPeer() {
        const id = prompt("Enter Peer ID:");
        if(id && STATE.p2p.peer) {
            const conn = STATE.p2p.peer.connect(id);
            conn.on('open', () => { STATE.p2p.conn = conn; setupConnection(conn); addP2PMsg('System', `Connected to ${id}`); render(); });
        }
    }
    function setupConnection(conn) { conn.on('data', (data) => { addP2PMsg('Remote', data); render(); }); }
    function addP2PMsg(user, msg) { STATE.p2p.messages.push({ user, msg, time: new Date().toLocaleTimeString() }); }
    function sendP2PMsg() {
        if(STATE.p2p.conn && STATE.chatInput) { STATE.p2p.conn.send(STATE.chatInput); addP2PMsg('You', STATE.chatInput); STATE.chatInput = ''; render(); }
    }

    // --- RENDER ENGINE ---
    function navigate(id) { STATE.view = id; render(); }
    
    function render() {
        const content = $('mainContent');
        const nav = $('navBar');
        const sidenav = $('sidebarNav');
        const mobnav = $('mobileNav');

        // Navs
        nav.innerHTML = SECTIONS.slice(0, 5).map(s => 
            `<button onclick="navigate('${s.id}')" class="px-2 py-1 rounded text-[10px] font-mono transition ${STATE.view === s.id ? 'text-cyan-300 bg-white/5' : 'text-gray-500 hover:text-white'}">${s.label}</button>`
        ).join('');
        
        sidenav.innerHTML = SECTIONS.map(s => 
            `<button onclick="navigate('${s.id}')" class="w-full text-left px-3 py-2 rounded text-sm font-mono transition flex items-center gap-3 ${STATE.view === s.id ? 'text-cyan-300 bg-white/5' : 'text-gray-500 hover:bg-white/5'}">
                <span class="w-5 text-center">${s.icon}</span> 
                <span>${s.label}</span>
            </button>`
        ).join('');
        
        mobnav.innerHTML = SECTIONS.map(s => 
            `<button onclick="navigate('${s.id}')" class="flex flex-col items-center text-[10px] px-3 py-2 whitespace-nowrap ${STATE.view === s.id ? 'text-cyan-400' : 'text-gray-500'}">
                <span class="text-lg mb-1">${s.icon}</span>
                <span>${s.label}</span>
           </button>`
        ).join('');

        // View
        content.style.animation = 'fade-in 0.3s ease';
        switch(STATE.view) {
            case 'Hyperspace': renderHyperspace(content); break;
            case 'Dashboard': renderDashboard(content); break;
            case 'ImageGen': renderImageGen(content); break;
            case 'AIChat': renderAIChat(content); break;
            case 'P2PChat': renderP2PChat(content); break;
            case 'Code': renderCode(content); break;
            case 'CLI': renderCLI(content); break;
            case 'Media': renderMedia(content); break;
            case 'Game': renderGame(content); break;
            case 'System': renderSystem(content); break;
            default: renderHyperspace(content);
        }
    }

    // --- HYPERSPACE (THE IMPRESSIVE FEATURE) ---
    function renderHyperspace(c) {
        c.innerHTML = `
            <div class="h-full w-full flex flex-col relative rounded-lg overflow-hidden border border-white/10 shadow-2xl">
                <div class="absolute top-0 left-0 right-0 h-8 glass-heavy flex items-center px-3 justify-between z-10 border-b border-white/5">
                    <div class="flex items-center gap-2">
                        <span class="text-pink-400 text-xs">LIVE</span>
                        <span class="text-[10px] font-mono text-gray-500">Hyperspace Module Active</span>
                    </div>
                    <div class="text-[10px] font-mono text-cyan-400">s12eh1dx2vs1-d.space.z.ai</div>
                </div>
                <iframe 
                    src="https://s12eh1dx2vs1-d.space.z.ai" 
                    class="flex-1 w-full h-full border-0" 
                    style="min-height: calc(100vh - 120px);"
                    allow="microphone; camera; midi; encrypted-media; fullscreen; display-capture"
                ></iframe>
            </div>`;
    }

    // --- DASHBOARD ---
    function renderDashboard(c) {
        c.innerHTML = `
            <div class="mb-8">
                <h1 class="text-3xl font-bold font-display tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-pink-400">System Overview</h1>
                <p class="text-gray-500 mt-2 text-sm">Quantum Neural Network Interface Active.</p>
            </div>
            <div class="grid md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-5 rounded-xl gradient-border group hover:border-cyan-500 transition-all cursor-pointer" onclick="navigate('Hyperspace')">
                    <div class="text-xs text-gray-500 mb-1 font-mono">ACTIVE MODULE</div>
                    <div class="text-2xl font-bold text-cyan-400">Hyperspace</div>
                    <p class="text-[10px] text-gray-600 mt-1">Click to Launch</p>
                </div>
                <div class="glass p-5 rounded-xl gradient-border">
                    <div class="text-xs text-gray-500 mb-1 font-mono">NEURAL LOAD</div>
                    <div id="statNeural" class="text-2xl font-bold text-pink-400">${STATE.stats.neural.toFixed(1)}%</div>
                </div>
                <div class="glass p-5 rounded-xl gradient-border">
                    <div class="text-xs text-gray-500 mb-1 font-mono">AI SENTIENCE</div>
                    <div class="text-2xl font-bold text-green-400">99.9%</div>
                </div>
                <div class="glass p-5 rounded-xl gradient-border">
                    <div class="text-xs text-gray-500 mb-1 font-mono">NODES</div>
                    <div id="statNodes" class="text-2xl font-bold text-yellow-400">${STATE.stats.nodes.toLocaleString()}</div>
                </div>
            </div>
            <div class="grid md:grid-cols-3 gap-4">
                <div onclick="navigate('ImageGen')" class="glass p-6 rounded-xl cursor-pointer hover:border-pink-500 transition group">
                    <div class="text-3xl mb-2 group-hover:scale-110 transition-transform inline-block">üé®</div>
                    <h3 class="font-bold text-lg mb-1">Image Synthesis</h3>
                    <p class="text-xs text-gray-400">Unlimited generative art.</p>
                </div>
                <div onclick="navigate('Game')" class="glass p-6 rounded-xl cursor-pointer hover:border-green-500 transition group">
                    <div class="text-3xl mb-2 group-hover:scale-110 transition-transform inline-block">üéÆ</div>
                    <h3 class="font-bold text-lg mb-1">Simulation</h3>
                    <p class="text-xs text-gray-400">Interactive playground.</p>
                </div>
                <div onclick="navigate('CLI')" class="glass p-6 rounded-xl cursor-pointer hover:border-cyan-500 transition group">
                    <div class="text-3xl mb-2 group-hover:scale-110 transition-transform inline-block">‚å®Ô∏è</div>
                    <h3 class="font-bold text-lg mb-1">Terminal</h3>
                    <p class="text-xs text-gray-400">Direct system access.</p>
                </div>
            </div>`;
    }

    // --- IMAGE GEN ---
    function renderImageGen(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">Image Synthesis</h2>
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="glass p-6 rounded-xl">
                    <textarea id="imgPromptInput" class="w-full h-32 bg-black/30 border border-white/10 rounded p-3 text-sm focus:outline-none focus:border-cyan-500" placeholder="Describe your vision..."></textarea>
                    <button onclick="generateImage()" class="mt-4 btn-primary px-6 py-2 rounded font-mono text-sm w-full">Generate</button>
                    <div class="mt-4 h-0.5 bg-white/5"><div id="imgProgress" class="h-full bg-gradient-to-r from-cyan-500 to-pink-500 transition-all duration-200" style="width: 0%"></div></div>
                </div>
                <div class="glass p-2 rounded-xl flex flex-col items-center justify-center min-h-[400px] bg-black/20 overflow-hidden">
                    <img id="imgResult" class="max-w-full max-h-[70vh] object-contain rounded-lg hidden shadow-2xl shadow-cyan-500/20 transition-opacity duration-500" />
                    <div id="imgPlaceholder" class="text-gray-600 text-sm text-center px-4">Visual matrix empty</div>
                </div>
            </div>`;
    }
    
    async function generateImage() {
        const prompt = $('imgPromptInput').value; 
        if(!prompt) return;
        
        const imgEl = $('imgResult');
        const phEl = $('imgPlaceholder');
        const progressEl = $('imgProgress');

        // UI Loading State
        imgEl.classList.add('hidden');
        imgEl.src = ""; // Clear previous
        phEl.textContent = "Generating...";
        phEl.classList.remove('hidden');
        progressEl.style.width = '0%';

        // Generate
        const url = await AI.image(prompt, (p) => {
            progressEl.style.width = p + '%';
        });

        // Display Result
        // We set src first, then wait for it to load before showing to ensure smooth transition
        imgEl.src = url;
        
        imgEl.onload = () => {
            phEl.classList.add('hidden');
            imgEl.classList.remove('hidden');
            imgEl.style.opacity = 1;
        };
        
        imgEl.onerror = () => {
            phEl.textContent = "Error loading image.";
            phEl.classList.remove('hidden');
            imgEl.classList.add('hidden');
        };
    }

    // --- AI CHAT ---
    function renderAIChat(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">Neural Chat</h2>
            <div class="glass rounded-xl h-[70vh] flex flex-col">
                <div id="chatLog" class="flex-1 p-4 overflow-y-auto space-y-3"></div>
                <div class="p-4 border-t border-white/5 flex gap-2">
                    <input type="text" id="chatInputAI" class="flex-1 bg-black/30 border border-white/10 rounded px-4 py-2 text-sm focus:outline-none focus:border-cyan-500" placeholder="Message AI..." />
                    <button onclick="sendAIChat()" class="btn-primary px-6 py-2 rounded text-sm">Send</button>
                </div>
            </div>`;
        $('chatLog').innerHTML = STATE.chatHistory.map(m => 
            `<div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-md p-3 rounded-lg ${m.role === 'user' ? 'bg-cyan-500/10 text-white' : 'bg-white/5 text-gray-300'}">
                    <div class="text-sm">${m.content}</div>
                </div>
            </div>`
        ).join('');
    }
    async function sendAIChat() {
        const input = $('chatInputAI'); const msg = input.value; if(!msg) return;
        STATE.chatHistory.push({ role: 'user', content: msg }); input.value = ''; render();
        const response = await AI.chat(STATE.chatHistory.map(m=>`${m.role}: ${m.content}`).join('\n'));
        STATE.chatHistory.push({ role: 'assistant', content: response }); render();
    }

    // --- P2P CHAT ---
    function renderP2PChat(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">Network Chat</h2>
            <div class="glass p-4 rounded-xl mb-4 text-center">
                <p class="text-xs text-gray-500">Your ID:</p>
                <div class="font-mono text-cyan-400 select-all cursor-pointer text-sm" onclick="navigator.clipboard.writeText(this.innerText)">${STATE.user.id || 'Connecting...'}</div>
                <button onclick="connectPeer()" class="mt-2 text-xs px-3 py-1 border border-white/10 rounded hover:bg-white/5">Connect</button>
            </div>
            <div class="glass rounded-xl h-[50vh] flex flex-col">
                <div id="p2pLog" class="flex-1 p-4 overflow-y-auto space-y-2"></div>
                <div class="p-4 border-t border-white/5 flex gap-2">
                    <input type="text" id="p2pInput" class="flex-1 bg-black/30 border border-white/10 rounded px-4 py-2 text-sm" placeholder="Message..." ${STATE.p2p.conn ? '' : 'disabled'} />
                    <button onclick="sendP2PMsg()" class="btn-primary px-6 py-2 rounded text-sm" ${STATE.p2p.conn ? '' : 'disabled'}>Send</button>
                </div>
            </div>`;
        $('p2pLog').innerHTML = STATE.p2p.messages.map(m => 
            `<div class="text-xs ${m.user === 'You' ? 'text-right' : 'text-left'} text-gray-400">[${m.time}] <span class="text-cyan-300">${m.user}:</span> ${m.msg}</div>`
        ).join('');
    }

    // --- CODE ---
    function renderCode(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">Copilot</h2>
            <div class="grid lg:grid-cols-2 gap-6 h-[70vh]">
                <div class="glass p-4 rounded-xl flex flex-col">
                    <textarea id="codeInput" class="flex-1 bg-black/30 border border-white/10 rounded p-3 text-sm font-mono focus:outline-none focus:border-cyan-500 resize-none">console.log("System Ready");</textarea>
                </div>
                <div class="glass p-4 rounded-xl flex flex-col">
                    <button onclick="runCode()" class="text-xs px-2 py-1 mb-2 bg-green-500/20 text-green-300 rounded self-end">Run</button>
                    <div id="codeOutput" class="flex-1 bg-black/50 rounded p-3 font-mono text-xs text-gray-300 overflow-y-auto whitespace-pre-wrap"></div>
                </div>
            </div>`;
    }
    function runCode() {
        const code = $('codeInput').value; const out = $('codeOutput');
        out.innerHTML = '> Running...\n';
        try { eval(code); } catch(e) { out.innerHTML += `Error: ${e.message}`; }
    }

    // --- CLI ---
    function renderCLI(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">Terminal</h2>
            <div class="glass rounded-xl p-4 h-[70vh] flex flex-col font-mono text-sm">
                <div id="cliOutput" class="flex-1 overflow-y-auto space-y-1 text-gray-300"></div>
                <div class="flex items-center gap-2 mt-2 border-t border-white/10 pt-2">
                    <span class="text-cyan-400">$</span>
                    <input type="text" id="cliInput" class="flex-1 bg-transparent outline-none text-white" placeholder="help..." />
                </div>
            </div>`;
        $('cliOutput').innerHTML = STATE.console.history.join('<br>');
        $('cliInput').onkeydown = (e) => {
            if(e.key === 'Enter') {
                const cmd = $('cliInput').value;
                STATE.console.history.push(`<span class="text-cyan-400">$ ${cmd}</span>`);
                processCmd(cmd);
                $('cliInput').value = '';
                render();
            }
        };
    }
    function processCmd(cmd) {
        const c = cmd.trim().toLowerCase();
        if(c === 'help') STATE.console.history.push('Commands: help, status, clear, hyperspace');
        else if(c === 'status') STATE.console.history.push('Status: <span class="text-green-400">OPERATIONAL</span>');
        else if(c === 'clear') STATE.console.history = [];
        else if(c === 'hyperspace') { STATE.console.history.push('Launching Hyperspace...'); setTimeout(()=>navigate('Hyperspace'), 500); }
        else STATE.console.history.push(`Unknown: ${cmd}`);
    }

    // --- MEDIA ---
    function renderMedia(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">Media Desk</h2>
            <div class="glass p-4 rounded-xl h-96 flex flex-col items-center justify-center text-center">
                 <p class="text-gray-500 text-sm mb-4">Local File Player</p>
                 <input type="file" id="mediaFileInput" class="text-xs hidden" accept="video/*,audio/*" onchange="loadMediaFile(this)" />
                 <button onclick="$('mediaFileInput').click()" class="btn-primary px-4 py-2 rounded text-sm">Load Media</button>
                 <div id="mediaContainer" class="mt-4 w-full max-w-2xl hidden">
                    <video id="mediaPlayer" controls class="w-full rounded shadow-lg"></video>
                 </div>
            </div>`;
    }
    function loadMediaFile(input) {
        if(input.files[0]) {
            STATE.media.file = URL.createObjectURL(input.files[0]);
            $('mediaPlayer').src = STATE.media.file;
            $('mediaContainer').classList.remove('hidden');
        }
    }

    // --- GAME ---
    function renderGame(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">Game Studio</h2>
            <div class="glass p-4 rounded-xl">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-mono text-xs text-cyan-400">Score: ${STATE.game.score}</span>
                    <div class="flex gap-2">
                        <button onclick="startGame()" class="px-3 py-1 bg-green-500/20 text-green-300 rounded text-xs">Start</button>
                        <button onclick="stopGame()" class="px-3 py-1 bg-red-500/20 text-red-300 rounded text-xs">Stop</button>
                    </div>
                </div>
                <canvas id="gameCanvas" width="800" height="300" class="w-full bg-black rounded border border-white/10"></canvas>
                <p class="text-[10px] text-gray-600 mt-2">Controls: Arrow Keys, Space to Jump</p>
            </div>`;
        if(STATE.game.running) requestAnimationFrame(gameLoop);
    }
    function startGame() { STATE.game = { ...STATE.game, running: true, score: 0, x: 100, y: 150, vx: 0, vy: 0 }; render(); }
    function stopGame() { STATE.game.running = false; render(); }
    function gameLoop() {
        if(!STATE.game.running) return;
        const cvs = $('gameCanvas'); if(!cvs) return;
        const ctx = cvs.getContext('2d');
        STATE.game.vy += 0.5;
        STATE.game.x += STATE.game.vx;
        STATE.game.y += STATE.game.vy;
        if(STATE.game.y > 250) { STATE.game.y = 250; STATE.game.vy = 0; }
        STATE.game.x = Math.max(20, Math.min(780, STATE.game.x));
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,800,300);
        ctx.fillStyle = '#111'; ctx.fillRect(0, 260, 800, 40);
        ctx.strokeStyle = '#0ff'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(0,260); ctx.lineTo(800,260); ctx.stroke();
        ctx.fillStyle = '#00f0ff'; ctx.shadowColor = '#00f0ff'; ctx.shadowBlur = 15; ctx.fillRect(STATE.game.x-10, STATE.game.y-20, 20, 40); ctx.shadowBlur = 0;
        requestAnimationFrame(gameLoop);
    }
    window.onkeydown = (e) => {
        if(e.code === 'ArrowLeft') STATE.game.vx = -5;
        if(e.code === 'ArrowRight') STATE.game.vx = 5;
        if(e.code === 'Space' && STATE.game.y >= 250) STATE.game.vy = -10;
    };
    window.onkeyup = (e) => { if(e.code === 'ArrowLeft' || e.code === 'ArrowRight') STATE.game.vx = 0; };

    // --- SYSTEM ---
    function renderSystem(c) {
        c.innerHTML = `
            <h2 class="text-2xl font-bold font-display mb-6">System</h2>
            <div class="glass p-6 rounded-xl text-center text-gray-500 text-xs">
                <p>Neural Core Temperature: 42¬∞C</p>
                <p class="mt-2 text-cyan-400">Quantum State: Entangled</p>
            </div>`;
    }

    // --- UTILS ---
    function updateProgress(id, val) { const el = $(id); if(el) el.style.width = val + '%'; }
    function toggleSettings() { $('settingsModal').classList.toggle('hidden'); $('settingsModal').classList.toggle('flex'); }
    
    function showTrailer() {
        const content = [
            { t: "NEXUS OS", delay: 0 },
            { t: "Quantum Interface", delay: 2000 },
            { t: "Hyperspace Enabled", delay: 4000 },
        ];
        $('trailerModal').classList.remove('hidden');
        $('trailerModal').classList.add('flex');
        $('trailerContent').innerHTML = '';
        content.forEach(item => {
            setTimeout(() => {
                const div = create('div', 'trailer-text text-4xl font-display text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-pink-400 mb-4', item.t);
                $('trailerContent').appendChild(div);
            }, item.delay);
        });
        setTimeout(() => { $('trailerModal').classList.add('hidden'); $('trailerModal').classList.remove('flex'); }, 6000);
    }

    // --- INIT ---
    window.onload = () => { boot(); };

</script>
</body>
</html>
